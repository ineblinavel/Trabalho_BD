{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <h1 class="h3 mb-1">Portal Médico - Dr(a). {{ session['username'] }}</h1>
    <p class="text-muted">Área clínica e assistencial</p>
    <div id="medico-data" data-crm="{{ session['referencia_id'] }}"></div>
</div>

<div class="row">
    <div class="col-md-3 mb-4">
        <div class="list-group shadow-sm" id="list-tab" role="tablist">
            
            <a class="list-group-item list-group-item-action active d-flex align-items-center py-3" 
               id="list-agenda-list" data-bs-toggle="list" href="#list-agenda" role="tab">
                <i class="bi bi-calendar-week fs-5 me-3 text-primary"></i>
                <div>
                    <div class="fw-bold">Minha Agenda</div>
                    <small class="text-muted">Meus Plantões</small>
                </div>
            </a>
            
            <a class="list-group-item list-group-item-action d-flex align-items-center py-3" 
               id="list-consultas-list" data-bs-toggle="list" href="#list-consultas" role="tab">
                <i class="bi bi-heart-pulse fs-5 me-3 text-danger"></i>
                <div>
                    <div class="fw-bold">Atendimentos</div>
                    <small class="text-muted">Consultar e Receitar</small>
                </div>
            </a>

            <a class="list-group-item list-group-item-action d-flex align-items-center py-3" 
               id="list-exames-list" data-bs-toggle="list" href="#list-exames" role="tab">
                <i class="bi bi-file-earmark-medical fs-5 me-3 text-info"></i>
                <div>
                    <div class="fw-bold">Exames</div>
                    <small class="text-muted">Solicitações e Laudos</small>
                </div>
            </a>

            <a class="list-group-item list-group-item-action d-flex align-items-center py-3" 
               id="list-pacientes-list" data-bs-toggle="list" href="#list-pacientes" role="tab">
                <i class="bi bi-journal-medical fs-5 me-3 text-warning"></i>
                <div>
                    <div class="fw-bold">Prontuários</div>
                    <small class="text-muted">Histórico Clínico</small>
                </div>
            </a>
        </div>
    </div>

    <div class="col-md-9">
        <div class="tab-content" id="nav-tabContent">
            
            <div class="tab-pane fade show active" id="list-agenda" role="tabpanel">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon-box primary me-3">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">Meus Horários</h5>
                                <p class="text-muted small mb-0">Visualize sua grade de plantões e slots livres.</p>
                            </div>
                        </div>
                        
                        <div id="agenda-container" class="text-center py-5 bg-light rounded border border-dashed">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="text-muted mt-3 mb-0">Carregando sua agenda...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="list-consultas" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-box danger me-3">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0">Fila de Espera</h5>
                                    <p class="text-muted small mb-0">Pacientes agendados para hoje.</p>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise me-1"></i> Atualizar
                            </button>
                        </div>

                        <div id="consultas-container" class="text-center py-5 bg-light rounded border border-dashed">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="text-muted mt-3 mb-0">Buscando consultas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="list-exames" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon-box info me-3">
                                <i class="bi bi-activity"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">Central de Exames</h5>
                                <p class="text-muted small mb-0">Gerencie solicitações laboratoriais e de imagem.</p>
                            </div>
                        </div>

                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card h-100 border bg-light">
                                    <div class="card-body text-center p-4">
                                        <div class="mb-3 text-primary">
                                            <i class="bi bi-plus-circle" style="font-size: 2rem;"></i>
                                        </div>
                                        <h6>Solicitar Novo Exame</h6>
                                        <p class="small text-muted mb-3">Solicitação avulsa para pacientes.</p>
                                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#modalSolicitarExame">
                                            <i class="bi bi-file-earmark-plus me-2"></i> Solicitar Agora
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100 border bg-light">
                                    <div class="card-body text-center p-4">
                                        <div class="mb-3 text-info">
                                            <i class="bi bi-list-check" style="font-size: 2rem;"></i>
                                        </div>
                                        <h6>Resultados e Histórico</h6>
                                        <p class="small text-muted mb-3">Visualize laudos e status de exames.</p>
                                        <a href="/ui/exames" class="btn btn-outline-info w-100">
                                            <i class="bi bi-search me-2"></i> Ver Todos os Exames
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="list-pacientes" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon-box warning me-3">
                                <i class="bi bi-search"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">Buscar Paciente</h5>
                                <p class="text-muted small mb-0">Acesse históricos clínicos antigos.</p>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <a href="/ui/pacientes" class="btn btn-warning w-100 p-4 text-white text-start">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1">Acessar Base de Pacientes</h5>
                                            <p class="mb-0 small text-white-50">Consulte dados cadastrais e prontuário completo.</p>
                                        </div>
                                        <i class="bi bi-chevron-right fs-4"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalSolicitarExame" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Solicitar Novo Exame</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="id_consulta_exame">
                
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">Paciente</label>
                    <select class="form-select" id="solicitacao_paciente">
                        <option value="" selected disabled>Carregando pacientes...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">Tipo de Exame</label>
                    <select class="form-select" id="tipo_exame_select">
                        <option value="" selected disabled>Carregando exames...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">Médico Responsável</label>
                    <select class="form-select" id="solicitacao_medico" required>
                        <option value="" selected disabled>Carregando médicos...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">Data Solicitação</label>
                    <input type="date" class="form-control" id="solicitacao_data" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarSolicitacaoExame()">Solicitar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAtendimento" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-clipboard-pulse me-2"></i>Realizar Consulta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold text-danger" id="atend-paciente-nome">Nome do Paciente</h6>
                            <small class="text-muted" id="atend-paciente-cpf">CPF: ...</small>
                        </div>
                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                            <i class="bi bi-calendar-event me-1"></i> Hoje
                        </span>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3 text-dark border-bottom pb-2">1. Diagnóstico Clínico</h6>
                        <div class="mb-2">
                            <label class="form-label text-muted small">Descrição do Diagnóstico</label>
                            <textarea class="form-control" id="atend-diagnostico" rows="3" placeholder="Descreva os sintomas, observações e a conclusão clínica..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3 text-dark border-bottom pb-2">2. Prescrição / Receita</h6>
                        
                        <div class="bg-white p-3 rounded border mb-3">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-5">
                                    <label class="small text-muted fw-bold">Medicamento</label>
                                    <select id="presc-medicamento" class="form-select form-select-sm"></select>
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted fw-bold">Qtd.</label>
                                    <input type="number" id="presc-qtd" class="form-control form-select-sm" value="1" min="1">
                                </div>
                                <div class="col-md-3">
                                    <label class="small text-muted fw-bold">Dosagem/Freq.</label>
                                    <input type="text" id="presc-uso" class="form-control form-select-sm" placeholder="Ex: 8/8h">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-sm btn-danger w-100" onclick="adicionarItemPrescricao()">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 small" id="tabela-prescricao">
                                <thead class="table-light">
                                    <tr>
                                        <th>Medicamento</th>
                                        <th>Instruções de Uso</th>
                                        <th class="text-end">Remover</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top-0">
                <input type="hidden" id="atend-id-consulta">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger px-4 shadow-sm" onclick="finalizarAtendimento()">
                    <i class="bi bi-check-circle-fill me-2"></i> Finalizar & Salvar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %} 

{% block scripts %}
<script src="/static/js/portal_medico.js"></script>
{% endblock %}